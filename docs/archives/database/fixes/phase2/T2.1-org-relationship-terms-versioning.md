# T2.1: Organization Relationship Terms Versioning

**Priority:** High  
**Phase:** 2  
**Estimated Time:** 3 days  
**Dependencies:** None

---

## ðŸŽ¯ Problem Statement

### **Current Flawed Design:**

Organization relationship terms are **static and overwrite history** when changed:

```sql
org_relationships (
    id UUID PRIMARY KEY,
    parent_org_id UUID,
    child_org_id UUID,
    rel_type TEXT,
    
    -- âŒ PROBLEM: These fields change over time but lose history!
    commission_percentage NUMERIC(5,2),     -- Changes: 10% â†’ 12% â†’ 15%
    payment_terms JSONB,                    -- Changes: Net30 â†’ Net45
    credit_limit NUMERIC(18,2),             -- Increases: 1M â†’ 2M â†’ 5M
    annual_target NUMERIC(18,2),            -- Changes yearly: 10M â†’ 15M â†’ 20M
    performance_tier TEXT,                  -- Upgrades: Silver â†’ Gold â†’ Platinum
    priority_level INT,                     -- Changes based on performance
    
    start_date DATE,
    end_date DATE,
    updated_at TIMESTAMPTZ                  -- âŒ Just timestamp, not full history!
)
```

### **Critical Problems:**

1. âŒ **Commission History Lost**
   - Dealer gets upgrade: 10% â†’ 12%
   - Can't calculate: "What commission did we pay in Q1 2024?"
   - Financial audit impossible

2. âŒ **Credit Limit Changes Untracked**
   - Credit limit increased: â‚¹1M â†’ â‚¹2M
   - When was it increased? Who approved it? Why?
   - No audit trail for compliance

3. âŒ **Annual Targets Overwritten**
   - New year target set: â‚¹10M â†’ â‚¹15M
   - Last year's target lost
   - Can't compare: "Did they meet 2023 target?"

4. âŒ **Payment Terms Changes**
   - Terms improved: Net-30 â†’ Net-45
   - When did this change take effect?
   - Active invoices confusion

5. âŒ **Performance Tier History Missing**
   - Dealer upgraded: Silver â†’ Gold â†’ Platinum
   - Can't track: "When did they become Gold?"
   - Incentive calculations wrong

6. âŒ **Concurrent Term Changes**
   - Multiple terms change at once (commission + credit + tier)
   - Each change overwrites previous
   - Complex to manage multiple changes

---

## âœ… Correct Design

### **Separation of Concerns:**

```sql
-- 1. org_relationships: Basic relationship info (relatively static)
org_relationships (
    id UUID PRIMARY KEY,
    parent_org_id UUID FK,
    child_org_id UUID FK,
    rel_type TEXT,                  -- Distributor, Dealer, etc.
    relationship_status TEXT,        -- active, inactive, suspended
    start_date DATE,                -- Relationship start
    end_date DATE,                  -- Relationship end (if terminated)
    auto_renew BOOLEAN,
    exclusive BOOLEAN,
    territory_id UUID FK,
    contract_reference TEXT,
    created_at TIMESTAMPTZ,
    updated_at TIMESTAMPTZ,
    created_by TEXT,
    notes TEXT
);

-- 2. org_relationship_terms: Version-controlled business terms
org_relationship_terms (
    id UUID PRIMARY KEY,
    relationship_id UUID FK,        -- Link to org_relationships
    version INT,                    -- 1, 2, 3, ... (sequential)
    
    -- Temporal validity
    effective_from TIMESTAMPTZ,     -- When these terms start
    effective_to TIMESTAMPTZ,       -- When these terms end (NULL = current)
    
    -- Business terms (what changes over time)
    commission_percentage NUMERIC(5,2),
    payment_terms JSONB,            -- {type: "net_days", days: 30, ...}
    credit_limit NUMERIC(18,2),
    credit_currency VARCHAR(3),
    annual_target NUMERIC(18,2),
    annual_target_currency VARCHAR(3),
    performance_tier TEXT,          -- Bronze, Silver, Gold, Platinum
    priority_level INT,             -- 1=highest, 5=lowest
    
    -- Pricing rules
    discount_percentage NUMERIC(5,2),
    special_pricing_applicable BOOLEAN,
    volume_incentives JSONB,        -- Bulk order bonuses
    
    -- Service commitments
    sla_terms JSONB,                -- Service level agreements
    support_level TEXT,             -- Basic, Standard, Premium
    training_included BOOLEAN,
    
    -- Audit trail
    changed_by TEXT,                -- Who made this change
    changed_at TIMESTAMPTZ,         -- When change was made
    change_reason TEXT,             -- Why was this changed
    approved_by TEXT,               -- Who approved (if applicable)
    approval_date TIMESTAMPTZ,
    
    -- Metadata
    notes TEXT,
    metadata JSONB,
    
    -- Constraints
    CONSTRAINT effective_dates_valid CHECK (
        effective_to IS NULL OR effective_to >= effective_from
    ),
    CONSTRAINT no_overlap EXCLUDE USING gist (
        relationship_id WITH =,
        tstzrange(effective_from, COALESCE(effective_to, '9999-12-31'::timestamptz), '[]') WITH &&
    )
);
```

---

## ðŸ”§ Key Features

### **1. Temporal Queries**
```sql
-- Get current terms for a relationship
SELECT * FROM org_relationship_terms
WHERE relationship_id = 'rel-uuid'
    AND effective_to IS NULL;

-- Get terms at specific date (e.g., what was commission in Q1 2024?)
SELECT commission_percentage, performance_tier
FROM org_relationship_terms
WHERE relationship_id = 'rel-uuid'
    AND '2024-01-15' >= effective_from
    AND ('2024-01-15' <= effective_to OR effective_to IS NULL);

-- Get complete history of changes
SELECT version, effective_from, effective_to, 
       commission_percentage, annual_target, changed_by, change_reason
FROM org_relationship_terms
WHERE relationship_id = 'rel-uuid'
ORDER BY version DESC;
```

### **2. Version Management**
```sql
-- Automatic version incrementing
CREATE OR REPLACE FUNCTION update_relationship_terms(
    p_relationship_id UUID,
    p_new_commission NUMERIC,
    p_new_credit_limit NUMERIC,
    p_effective_from TIMESTAMPTZ,
    p_changed_by TEXT,
    p_reason TEXT
)
RETURNS UUID AS $$
DECLARE
    v_new_version INT;
    v_new_id UUID;
BEGIN
    -- Close current terms
    UPDATE org_relationship_terms
    SET effective_to = p_effective_from
    WHERE relationship_id = p_relationship_id
        AND effective_to IS NULL;
    
    -- Get next version number
    SELECT COALESCE(MAX(version), 0) + 1 INTO v_new_version
    FROM org_relationship_terms
    WHERE relationship_id = p_relationship_id;
    
    -- Create new version
    INSERT INTO org_relationship_terms (
        relationship_id, version, effective_from,
        commission_percentage, credit_limit,
        changed_by, changed_at, change_reason
    ) VALUES (
        p_relationship_id, v_new_version, p_effective_from,
        p_new_commission, p_new_credit_limit,
        p_changed_by, NOW(), p_reason
    )
    RETURNING id INTO v_new_id;
    
    RETURN v_new_id;
END;
$$ LANGUAGE plpgsql;
```

### **3. No Overlap Constraint**
```sql
-- Ensures only ONE set of terms is active at any point in time
EXCLUDE USING gist (
    relationship_id WITH =,
    tstzrange(effective_from, effective_to) WITH &&
)
```

### **4. Audit Trail**
Every change tracked with:
- Who changed it (`changed_by`)
- When changed (`changed_at`)
- Why changed (`change_reason`)
- Who approved (`approved_by`)

---

## ðŸ“‹ Migration Strategy

### **Step 1: Create New Tables**
```sql
CREATE TABLE org_relationship_terms (...);
CREATE INDEXES ...;
CREATE HELPER FUNCTIONS ...;
```

### **Step 2: Migrate Existing Data**
```sql
-- Migrate current terms as version 1
INSERT INTO org_relationship_terms (
    relationship_id, version, effective_from,
    commission_percentage, payment_terms, credit_limit,
    annual_target, performance_tier, priority_level,
    changed_by, change_reason
)
SELECT
    id as relationship_id,
    1 as version,
    COALESCE(start_date, created_at)::timestamptz as effective_from,
    commission_percentage,
    payment_terms,
    credit_limit,
    annual_target,
    performance_tier,
    priority_level,
    'migration_T2.1' as changed_by,
    'Migrated from org_relationships table' as change_reason
FROM org_relationships
WHERE relationship_status = 'active';
```

### **Step 3: Create Views for Backward Compatibility**
```sql
-- View showing relationships with current terms
CREATE VIEW org_relationships_with_current_terms AS
SELECT
    r.*,
    t.commission_percentage,
    t.payment_terms,
    t.credit_limit,
    t.annual_target,
    t.performance_tier,
    t.priority_level,
    t.version as terms_version,
    t.effective_from as terms_effective_from
FROM org_relationships r
LEFT JOIN org_relationship_terms t ON (
    r.id = t.relationship_id
    AND t.effective_to IS NULL
);
```

### **Step 4: Update Application Code (Gradual)**
- Phase 1: Read from view (backward compatible)
- Phase 2: Update writes to use new table
- Phase 3: Drop old columns from org_relationships

### **Step 5: Remove Old Columns**
```sql
-- After all code updated and tested
ALTER TABLE org_relationships
DROP COLUMN commission_percentage,
DROP COLUMN payment_terms,
DROP COLUMN credit_limit,
DROP COLUMN annual_target,
DROP COLUMN performance_tier,
DROP COLUMN priority_level;
```

---

## ðŸŽ¯ Use Case Examples

### **Example 1: Annual Target Update (New Year)**
```sql
-- Set new annual target for 2025
SELECT update_relationship_terms(
    'rel-abc-123',                  -- relationship_id
    12.0,                           -- commission (unchanged)
    2000000.00,                     -- credit (unchanged)
    '2025-01-01 00:00:00+00',       -- effective_from (new year)
    'sales_manager@company.com',    -- changed_by
    'Annual target update for FY2025'  -- reason
);
```

### **Example 2: Commission Upgrade Based on Performance**
```sql
-- Dealer performed well, upgrade from 10% to 12%
SELECT update_relationship_terms(
    'rel-dealer-xyz',
    12.0,                           -- commission (upgraded)
    1500000.00,                     -- credit (unchanged)
    '2024-07-01 00:00:00+00',       -- mid-year upgrade
    'regional_head@company.com',
    'Performance-based commission upgrade - Q2 targets exceeded by 150%'
);
```

### **Example 3: Credit Limit Increase**
```sql
-- Distributor proven trustworthy, increase credit
SELECT update_relationship_terms(
    'rel-dist-abc',
    10.0,                           -- commission (unchanged)
    5000000.00,                     -- credit (increased from 2M to 5M)
    '2024-11-16 10:00:00+00',
    'finance_manager@company.com',
    'Credit limit increased based on payment history - zero delays in 2 years'
);
```

### **Example 4: Query Historical Commission for Financial Audit**
```sql
-- Finance needs to know: What commission rate was in Q1 2024?
SELECT
    commission_percentage,
    effective_from,
    effective_to,
    changed_by,
    change_reason
FROM org_relationship_terms
WHERE relationship_id = 'rel-dealer-xyz'
    AND '2024-01-15' >= effective_from
    AND ('2024-01-15' <= effective_to OR effective_to IS NULL);

-- Result: 10% (before July upgrade to 12%)
```

### **Example 5: Performance Tier Progression**
```sql
-- Track dealer's progression: Bronze â†’ Silver â†’ Gold
SELECT
    version,
    performance_tier,
    annual_target,
    effective_from,
    change_reason
FROM org_relationship_terms
WHERE relationship_id = 'rel-dealer-123'
ORDER BY version ASC;

-- Results:
-- Version 1: Bronze, 10M, 2023-01-01, "Initial onboarding"
-- Version 2: Silver, 15M, 2024-01-01, "Achieved 110% of target"
-- Version 3: Gold, 20M, 2025-01-01, "Consistent high performance"
```

---

## ðŸ“Š Benefits

### **Before T2.1:**
- âŒ Commission changes overwrite history
- âŒ Can't calculate accurate historical payouts
- âŒ Financial audits impossible
- âŒ Annual targets lost each year
- âŒ No approval workflow
- âŒ Compliance risk

### **After T2.1:**
- âœ… Complete history of all term changes
- âœ… Accurate financial calculations for any date
- âœ… Full audit trail with reasons
- âœ… Multi-year target tracking
- âœ… Approval workflow supported
- âœ… Compliance ready

---

## ðŸ§ª Testing Checklist

- [ ] org_relationship_terms table created
- [ ] All indexes created
- [ ] Helper functions work
- [ ] No-overlap constraint prevents duplicates
- [ ] Current terms migrated correctly
- [ ] View returns correct data
- [ ] Temporal queries work (past dates)
- [ ] Version incrementing automatic
- [ ] Update function works
- [ ] Backward compatibility maintained

---

## ðŸ”„ Rollback Procedure

```sql
-- Drop new structures
DROP VIEW IF EXISTS org_relationships_with_current_terms CASCADE;
DROP FUNCTION IF EXISTS update_relationship_terms CASCADE;
DROP TABLE IF EXISTS org_relationship_terms CASCADE;

-- Old columns remain in org_relationships, no data lost
```

---

## âœ… Acceptance Criteria

- [ ] Complete term change history tracked
- [ ] Temporal queries work accurately
- [ ] No data loss during migration
- [ ] Backward compatible views work
- [ ] Zero downtime deployment
- [ ] Documentation complete
- [ ] Performance acceptable (<100ms queries)

---

**Status:** ðŸŸ¡ Ready for Implementation  
**Next:** Create SQL migration script

This fixes a CRITICAL gap in financial auditing and compliance! ðŸš€

# T1.4: Equipment Relationships Schema - Updated Based on Feedback ‚úÖ

## üìã Updated Schema (Ready for Review)

```sql
CREATE TABLE equipment_relationships (
    id UUID PRIMARY KEY,
    
    -- Equipment reference
    equipment_id VARCHAR(32) FK ‚Üí equipment_registry(id),
    
    -- Relationship type (7 types supported)
    relationship_type VARCHAR(50),
    -- 'manufacturer', 'distributor', 'dealer', 'owner', 
    -- 'facility', 'service_provider', 'leasing_company'
    
    -- Related entities
    related_org_id UUID,            -- Organization reference
    related_facility_id UUID,       -- Facility reference
    entity_name VARCHAR(500),       -- Denormalized for history
    entity_type VARCHAR(50),        -- 'hospital', 'clinic', 'dealer'
    
    -- üÜï Enhanced Location Tracking
    location_details JSONB,         -- Building, floor, room, department, ward
    address JSONB,                  -- Full address details
    gps_latitude DECIMAL(10, 8),    -- ‚úÖ GPS coordinates added
    gps_longitude DECIMAL(11, 8),   -- ‚úÖ GPS coordinates added
    
    -- üÜï Temporal with Timestamp Precision
    effective_from TIMESTAMPTZ,     -- ‚úÖ Changed from DATE to TIMESTAMPTZ
    effective_to TIMESTAMPTZ,       -- ‚úÖ Changed from DATE to TIMESTAMPTZ
    
    -- Status
    relationship_status VARCHAR(50), -- 'active', 'terminated', 'transferred'
    
    -- Transfer information
    reason VARCHAR(255),
    transfer_type VARCHAR(50),      -- 'sale', 'lease', 'transfer'
    transfer_documents JSONB,
    
    -- üÜï Financial Details (for leasing)
    transaction_amount DECIMAL(15,2),
    transaction_currency VARCHAR(3),
    payment_terms JSONB,            -- ‚úÖ Added for leasing/installments
    contract_reference VARCHAR(100),
    
    -- Audit trail
    notes TEXT,
    created_at TIMESTAMPTZ,
    created_by VARCHAR(255),
    terminated_at TIMESTAMPTZ,
    terminated_by VARCHAR(255),
    termination_reason TEXT
);
```

---

## ‚úÖ Changes Based on Your Feedback

### **1. Relationship Types** ‚úÖ
**Status:** Confirmed - 7 types are sufficient

- `manufacturer`
- `distributor`
- `dealer`
- `owner`
- `facility`
- `service_provider`
- `leasing_company`

### **2. Multiple Relationships** ‚úÖ
**Confirmed:**
- ‚úÖ Multiple **different** types at same time (owner + facility + service_provider)
- ‚ùå Multiple of **same** type simultaneously

**Implementation:**
```sql
-- EXCLUDE constraint prevents overlapping same-type relationships
EXCLUDE USING gist (
    equipment_id WITH =,
    relationship_type WITH =,
    tstzrange(effective_from, effective_to) WITH &&
)
```

### **3. Location Tracking** ‚úÖ
**Added GPS Coordinates:**
```sql
gps_latitude DECIMAL(10, 8),   -- Precision: ¬±1.1mm
gps_longitude DECIMAL(11, 8),  -- Precision: ¬±1.1mm
```

**Location Details JSONB Structure:**
```json
{
  "building": "Main Hospital Building",
  "floor": "3",
  "room": "ICU-301",
  "department": "Intensive Care",
  "ward": "ICU-A"
}
```

**Address JSONB Structure:**
```json
{
  "street": "123 Medical Center Drive",
  "city": "Mumbai",
  "state": "Maharashtra",
  "pincode": "400001",
  "country": "India"
}
```

### **4. Temporal Precision** ‚úÖ
**Changed from DATE to TIMESTAMPTZ:**
- ‚úÖ Supports same-day transfers with time precision
- ‚úÖ Timezone-aware for multi-region operations
- ‚úÖ Example: `2024-11-16 10:30:00+05:30` (IST)

**Benefits:**
```sql
-- Can track multiple events on same day
-- 10:00 AM: Equipment at Hospital A
-- 2:00 PM: Transferred to Hospital B
-- 5:00 PM: Moved to different department
```

### **5. Financial Details** ‚úÖ
**Kept for Leasing Purpose:**
```sql
transaction_amount DECIMAL(15,2),    -- Purchase/lease amount
payment_terms JSONB,                 -- ‚úÖ Added for lease terms
```

**Payment Terms Structure:**
```json
{
  "type": "lease",
  "duration_months": 36,
  "monthly_amount": 15000,
  "security_deposit": 50000,
  "payment_schedule": [
    {"due_date": "2024-01-01", "amount": 15000},
    {"due_date": "2024-02-01", "amount": 15000}
  ],
  "buyout_option": true,
  "buyout_amount": 100000
}
```

### **6. No Individual Ownership** ‚úÖ
**Confirmed:** No `related_person_id` needed
- Only organization-level relationships tracked
- Simplified schema

---

## üîß Updated Helper Functions

### **1. Get Current Owner**
```sql
SELECT * FROM get_current_owner('EQ-12345');

-- Returns:
-- owner_id | owner_name    | since_timestamp
-- ---------|---------------|------------------
-- uuid...  | Hospital A    | 2024-01-15 10:30:00+05:30
```

### **2. Temporal Query (with timestamp)**
```sql
SELECT * FROM get_owner_at_timestamp(
    'EQ-12345', 
    '2024-03-15 14:30:00+05:30'
);

-- Returns owner at that exact moment
```

### **3. Transfer Equipment (with payment terms)**
```sql
SELECT transfer_equipment(
    'EQ-12345',
    'hospital-b-uuid',
    'Hospital B',
    '2024-11-16 15:00:00+05:30',
    'Equipment purchased',
    'sale',
    5000000.00,
    '{"payment_type": "installment", "months": 12}'::jsonb,
    'admin@hospitala.com'
);
```

---

## üìä Use Case Examples

### **Use Case 1: Equipment Lease with GPS Tracking**
```sql
-- Hospital leases CT Scanner, track location with GPS
INSERT INTO equipment_relationships (
    equipment_id, relationship_type, related_org_id, entity_name,
    location_details, gps_latitude, gps_longitude,
    effective_from, transaction_amount, payment_terms
) VALUES (
    'EQ-CT-001',
    'owner',
    'hospital-uuid',
    'City Hospital',
    '{"building": "Radiology", "floor": "2", "room": "RAD-201"}',
    19.0760,  -- Mumbai coordinates
    72.8777,
    '2024-11-16 10:00:00+05:30',
    2500000.00,
    '{"type": "lease", "duration_months": 36, "monthly_amount": 75000}'
);
```

### **Use Case 2: Same-Day Transfer with Time Precision**
```sql
-- Morning: Equipment at Hospital A
-- 10:00 AM: Ownership transfer initiated
-- 2:00 PM: Equipment in transit
-- 5:00 PM: Equipment installed at Hospital B

-- All tracked with precise timestamps!
```

### **Use Case 3: Multiple Simultaneous Relationships**
```sql
-- Same equipment can have:
-- 1. Owner: Hospital A (started 2023-01-01)
-- 2. Facility: ICU Department (moved 2024-06-15)
-- 3. Service Provider: MedTech Services (contract 2024-01-01)
-- 4. Manufacturer: Siemens (always)

-- All active at same time, different relationship types
```

### **Use Case 4: Equipment Location History with GPS**
```sql
-- Query all past locations
SELECT 
    entity_name,
    gps_latitude,
    gps_longitude,
    effective_from,
    effective_to
FROM equipment_relationships
WHERE equipment_id = 'EQ-12345'
    AND relationship_type = 'facility'
ORDER BY effective_from DESC;

-- Shows complete movement history with GPS coordinates
```

---

## üéØ What's Included in Migration

1. ‚úÖ Table creation with all constraints
2. ‚úÖ EXCLUDE constraint for no-overlap enforcement
3. ‚úÖ 10+ indexes for performance
4. ‚úÖ Automatic data migration from equipment_registry
5. ‚úÖ Helper functions (get owner, transfer, history)
6. ‚úÖ Views for easy querying
7. ‚úÖ Full documentation and comments

---

## üìù Schema Validation Checklist

Please verify:

- [ ] **7 relationship types** are sufficient for your business
- [ ] **GPS coordinates** - do you have equipment that needs tracking?
- [ ] **TIMESTAMPTZ precision** - is this level of detail needed?
- [ ] **Payment terms JSONB** - does this structure work for your leasing?
- [ ] **No person ownership** - confirmed organizations only?
- [ ] **Multiple relationships** - can equipment have owner + facility + service_provider simultaneously?
- [ ] **Single same-type** - only ONE owner, ONE facility at a time?

---

## üöÄ Next Steps

Once you approve this schema:

1. Test the migration on dev database
2. Create domain models (Go structs)
3. Build repository layer
4. Build service layer
5. Add API endpoints (optional)

---

**Status:** üü° Awaiting Your Approval

Let me know if any adjustments needed! ü§ì
